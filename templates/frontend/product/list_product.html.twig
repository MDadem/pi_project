{# templates/frontend/product/list_product.html.twig #}
<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<title>CultureSpace</title>
	<meta content="width=device-width, initial-scale=1.0" name="viewport">
	<meta content="" name="keywords">
	<meta content="" name="description">
	<!-- Favicon -->
	<link rel="icon" type="image/png" href="{{ asset('img/logo3.png') }}"/>
	<!-- Google Web Fonts -->
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Inter:wght@100..900&family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">

	<!-- Icon Font Stylesheet -->
	<link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.4/css/all.css"/>
	<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.4.1/font/bootstrap-icons.css" rel="stylesheet">

	<!-- Libraries Stylesheet -->
	<link rel="stylesheet" href="{{ absolute_url(asset('lib/animate/animate.min.css')) }}"/>
	<link href="{{ absolute_url(asset('lib/lightbox/css/lightbox.min.css')) }}" rel="stylesheet">
	<link href="{{ absolute_url(asset('lib/owlcarousel/assets/owl.carousel.min.css')) }}" rel="stylesheet">

	<!-- Customized Bootstrap Stylesheet -->
	<link href="{{ absolute_url(asset('css/bootstrap.min.css')) }}" rel="stylesheet">

	<!-- Template Stylesheet -->
	<link href="{{ absolute_url(asset('css/style.css')) }}" rel="stylesheet">

	{% block stylesheets %}
		<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto|Open+Sans">
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css">
		<style>
			body {
				background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
				min-height: 100vh;
				font-family: 'Inter', sans-serif;
			}
			h2 {
				color: #2c3e50;
				font-size: 2.5rem;
				font-weight: 800;
				text-align: center;
				text-transform: uppercase;
				position: relative;
				margin: 3rem 0 4rem;
			}
			h2:after {
				content: '';
				position: absolute;
				width: 120px;
				height: 5px;
				background: linear-gradient(to right, #7ac400, #a3e635);
				left: 50%;
				bottom: -20px;
				transform: translateX(-50%);
				border-radius: 2px;
			}
			.container-xl {
				padding: 0 2rem;
				position: relative;
			}
			.filter-panel {
				/* Adjusted positioning to avoid header overlap */
				position: fixed;
				top: 200px; /* Increased to clear typical header height */
				left: 20px;
				width: 300px;
				max-height: calc(100vh - 220px); /* Adjusted to fit below header */
				background: rgba(255, 255, 255, 0.95);
				border-radius: 20px;
				box-shadow: 0 10px 50px rgba(0, 0, 0, 0.15);
				padding: 2rem;
				z-index: 900; /* Lowered below header z-index */
				transition: all 0.4s ease;
				transform: translateX(-100%);
				backdrop-filter: blur(5px);
				overflow-y: auto;
				scrollbar-width: thin;
				scrollbar-color: #7ac400 rgba(0, 0, 0, 0.1);
			}
			.filter-panel::-webkit-scrollbar {
				width: 8px;
			}
			.filter-panel::-webkit-scrollbar-track {
				background: rgba(0, 0, 0, 0.1);
				border-radius: 10px;
			}
			.filter-panel::-webkit-scrollbar-thumb {
				background: #7ac400;
				border-radius: 10px;
			}
			.filter-panel::-webkit-scrollbar-thumb:hover {
				background: #a3e635;
			}
			.filter-panel.active {
				transform: translateX(0);
			}
			.filter-panel:before {
				content: '';
				position: absolute;
				top: -50%;
				left: -50%;
				width: 200%;
				height: 200%;
				background: radial-gradient(circle, rgba(122,196,0,0.1) 0%, transparent 70%);
				transform: rotate(30deg);
				pointer-events: none;
			}
			.filter-toggle {
				/* Adjusted positioning to avoid header overlap */
				position: fixed;
				top: 160px; /* Increased to clear header */
				left: 20px;
				background: linear-gradient(45deg, #7ac400, #a3e635);
				color: white;
				border: none;
				border-radius: 50%;
				width: 50px;
				height: 50px;
				font-size: 1.5rem;
				display: flex;
				align-items: center;
				justify-content: center;
				cursor: pointer;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
				transition: all 0.3s ease;
				z-index: 901; /* Below header but above panel */
			}
			.filter-toggle:hover {
				transform: scale(1.1);
				box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
			}
			.filter-panel h3 {
				color: #2c3e50;
				font-size: 1.5rem;
				font-weight: 700;
				margin-bottom: 1.5rem;
				position: relative;
			}
			.filter-panel h3:after {
				content: '';
				position: absolute;
				bottom: -5px;
				left: 0;
				width: 50px;
				height: 3px;
				background: linear-gradient(to right, #7ac400, #a3e635);
			}
			.filter-panel .form-control,
			.filter-panel .form-select {
				border-radius: 10px;
				border: 2px solid #dee2e6;
				padding: 0.75rem 1rem;
				background: rgba(255, 255, 255, 0.8);
				transition: all 0.3s ease;
				margin-bottom: 1rem;
				box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
			}
			.filter-panel .form-control:focus,
			.filter-panel .form-select:focus {
				border-color: #7ac400;
				box-shadow: 0 0 10px rgba(122, 196, 0, 0.3);
				background: white;
			}
			.filter-panel .btn-primary {
				width: 100%;
				border-radius: 25px;
				padding: 0.75rem;
				font-weight: 700;
				text-transform: uppercase;
				letter-spacing: 1px;
				background: linear-gradient(45deg, #7ac400, #a3e635);
				border: none;
				transition: all 0.4s ease;
				position: relative;
				overflow: hidden;
			}
			.filter-panel .btn-primary:before {
				content: '';
				position: absolute;
				top: 50%;
				left: 50%;
				width: 0;
				height: 0;
				background: rgba(255, 255, 255, 0.2);
				border-radius: 50%;
				transform: translate(-50%, -50%);
				transition: width 0.6s ease, height 0.6s ease;
			}
			.filter-panel .btn-primary:hover:before {
				width: 300px;
				height: 300px;
			}
			.filter-panel .btn-primary:hover {
				transform: translateY(-3px);
				box-shadow: 0 8px 25px rgba(122, 196, 0, 0.4);
			}
			.carousel {
				margin: 0 auto;
				padding: 0 70px;
			}
			.carousel-item {
				transition: transform 0.5s ease, opacity 0.5s ease;
			}
			.thumb-wrapper {
				padding: 1.5rem;
				background: rgba(255, 255, 255, 0.95);
				border-radius: 15px;
				text-align: center;
				position: relative;
				box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
				transition: all 0.3s ease;
				overflow: hidden;
				backdrop-filter: blur(2px);
			}
			.thumb-wrapper:hover {
				transform: translateY(-5px);
				box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
			}
			.thumb-wrapper:before {
				content: '';
				position: absolute;
				top: -50%;
				left: -50%;
				width: 200%;
				height: 200%;
				background: radial-gradient(circle, rgba(122,196,0,0.05) 0%, transparent 70%);
				transform: rotate(30deg);
				pointer-events: none;
			}
			.img-box {
				height: 150px;
				margin-bottom: 1rem;
				position: relative;
				overflow: hidden;
				border-radius: 10px;
			}
			.img-box img {
				max-width: 100%;
				max-height: 100%;
				position: absolute;
				bottom: 0;
				left: 50%;
				transform: translateX(-50%);
				transition: all 0.3s ease;
			}
			.thumb-wrapper:hover .img-box img {
				transform: translateX(-50%) scale(1.05);
			}
			.thumb-content h4 {
				font-size: 1.2rem;
				color: #2c3e50;
				font-weight: 700;
				margin-bottom: 0.75rem;
			}
			.thumb-content p {
				font-size: 0.9rem;
				color: #34495e;
				margin-bottom: 0.5rem;
			}
			.item-price {
				font-size: 1rem;
				color: #7ac400;
				font-weight: 600;
				margin-bottom: 0.75rem;
			}
			.vote-score {
				font-size: 0.9rem;
				color: #2c3e50;
				font-weight: 600;
				margin-bottom: 0.5rem;
			}
			.stock-status {
				display: inline-block;
				padding: 0.4rem 0.8rem;
				border-radius: 15px;
				font-size: 0.8rem;
				font-weight: 600;
				text-transform: uppercase;
				margin-bottom: 0.75rem;
			}
			.stock-status.in-stock {
				background: linear-gradient(45deg, #7ac400, #a3e635);
				color: white;
			}
			.stock-status.out-of-stock {
				background: linear-gradient(45deg, #ff416c, #ff4b2b);
				color: white;
			}
			.button-group {
				display: flex;
				justify-content: center;
				gap: 0.5rem;
				flex-wrap: wrap;
			}
			.btn {
				padding: 0.4rem 0.8rem;
				font-size: 0.85rem;
				font-weight: 600;
				text-transform: uppercase;
				border-radius: 12px;
				transition: all 0.3s ease;
				border: none;
				background: linear-gradient(45deg, #7ac400, #a3e635);
				color: white;
			}
			.btn:hover {
				transform: translateY(-2px);
				box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
			}
			.btn-vote-up {
				background: linear-gradient(45deg, #28a745, #34d058);
			}
			.btn-vote-down {
				background: linear-gradient(45deg, #6c757d, #adb5bd);
			}
			.btn-edit {
				background: linear-gradient(45deg, #ffb347, #ffcc33);
			}
			.btn-delete {
				background: linear-gradient(45deg, #ff416c, #ff4b2b);
			}
			.carousel-control-prev,
			.carousel-control-next {
				height: 40px;
				width: 40px;
				background: linear-gradient(45deg, #7ac400, #a3e635);
				border-radius: 50%;
				opacity: 0.9;
				top: 50%;
				transform: translateY(-50%);
			}
			.carousel-control-prev:hover,
			.carousel-control-next:hover {
				background: linear-gradient(45deg, #a3e635, #7ac400);
				opacity: 1;
				transform: translateY(-50%) scale(1.1);
			}
			.carousel-control-prev i,
			.carousel-control-next i {
				font-size: 1.5rem;
				color: white;
				text-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
			}
			.carousel-indicators {
				bottom: -50px;
			}
			.carousel-indicators li {
				width: 10px;
				height: 10px;
				background: rgba(122, 196, 0, 0.3);
				border-radius: 50%;
				transition: all 0.3s ease;
			}
			.carousel-indicators li.active {
				background: #7ac400;
				transform: scale(1.2);
			}
		</style>
	{% endblock %}
</head>
<body>
{% include 'frontend/topbar/topbar.html.twig' %}
{% include 'frontend/navbar/navbar.html.twig' %}

{% block body %}
	<div class="container-xl mt-4">
		<!-- PDF Download Button -->
		<div class="text-right mb-3">
			<a href="{{ path('product_list_pdf', app.request.query.all) }}" class="btn btn-success">
				<i class="fa fa-download"></i>
				Download PDF
			</a>
		</div>

		<!-- Filter Panel Toggle Button -->
		<button class="filter-toggle" id="filterToggle" title="Toggle Filters">
			<i class="fas fa-filter"></i>
		</button>

		<!-- Premium Filter Panel with Scroll -->
		<form method="get" action="{{ path('product_list') }}" class="filter-panel" id="filterPanel">
			<h3>Filter Products</h3>
			<div class="row g-3">
				<div class="col-12">
					<input type="text" name="name" placeholder="Product Name" value="{{ app.request.get('name') }}" class="form-control">
				</div>
				<div class="col-12">
					<input type="date" name="date_from" placeholder="Date From" value="{{ app.request.get('date_from') }}" class="form-control">
				</div>
				<div class="col-12">
					<input type="date" name="date_to" placeholder="Date To" value="{{ app.request.get('date_to') }}" class="form-control">
				</div>
				<div class="col-12">
					<select name="category" class="form-select">
						<option value="">All Categories</option>
						{% for cat in categories %}
							<option value="{{ cat.id }}" {% if app.request.get('category') == cat.id %} selected {% endif %}>
								{{ cat.name }}
							</option>
						{% endfor %}
					</select>
				</div>
				<div class="col-12">
					<input type="number" step="0.01" name="price_min" placeholder="Min Price" value="{{ app.request.get('price_min') }}" class="form-control">
				</div>
				<div class="col-12">
					<input type="number" step="0.01" name="price_max" placeholder="Max Price" value="{{ app.request.get('price_max') }}" class="form-control">
				</div>
				<div class="col-12">
					<select name="availability" class="form-select">
						<option value="all" {% if app.request.get('availability') == 'all' or app.request.get('availability') is empty %} selected {% endif %}>All</option>
						<option value="available" {% if app.request.get('availability') == 'available' %} selected {% endif %}>Available</option>
						<option value="unavailable" {% if app.request.get('availability') == 'unavailable' %} selected {% endif %}>Unavailable</option>
					</select>
				</div>
				<div class="col-12">
					<select name="discount" class="form-select">
						<option value="all" {% if app.request.get('discount') == 'all' or app.request.get('discount') is empty %} selected {% endif %}>All</option>
						<option value="discounted" {% if app.request.get('discount') == 'discounted' %} selected {% endif %}>Discounted</option>
						<option value="non_discounted" {% if app.request.get('discount') == 'non_discounted' %} selected {% endif %}>Non-Discounted</option>
					</select>
				</div>
				<div class="col-12">
					<button type="submit" class="btn btn-primary">Apply Filters</button>
				</div>
			</div>
		</form>

		<!-- Product List Container for Ajax Updates -->
		<div id="product-list-container">
			<div class="row">
				<div class="col-md-12">
					<h2>Featured <b>Products</b></h2>
					<div id="myCarousel" class="carousel slide" data-ride="carousel" data-interval="0">
						{% set groups = products|batch(4) %}
						<!-- Carousel indicators -->
						<ol class="carousel-indicators">
							{% for group in groups %}
								<li data-target="#myCarousel" data-slide-to="{{ loop.index0 }}" class="{{ loop.first ? 'active' : '' }}"></li>
							{% endfor %}
						</ol>
						<!-- Wrapper for carousel items -->
						<div class="carousel-inner">
							{% for productGroup in groups %}
								<div class="item carousel-item {{ loop.first ? 'active' : '' }}">
									<div class="row g-4">
										{% for product in productGroup %}
											<div class="col-sm-3">
												<div class="thumb-wrapper wow fadeInUp" data-wow-delay="{{ loop.index0 * 0.1 }}s">
													<div class="img-box">
														<img src="{{ product.imageUrl }}" class="img-fluid" alt="{{ product.productName }}">
													</div>
													<div class="thumb-content">
														<h4>{{ product.productName }}</h4>
														<p>{{ product.productDescription }}</p>
														<p>{{ product.productCategory.name }}</p>
														<span class="stock-status {{ product.productStock > 0 ? 'in-stock' : 'out-of-stock' }}">
																	{{ product.productStock > 0 ? 'In Stock' : 'Out of Stock' }}
																</span>
														<p class="vote-score">Upvotes: {{ product.voteScore }}</p>
														{% if product.useDynamicPricing %}
															<p class="item-price">
																<b>${{ product.dynamicPrice|number_format(2) }}</b>
																<span class="text-muted">(Dynamic Pricing)</span>
															</p>
														{% elseif product.discount %}
															<p class="item-price">
																<span style="text-decoration: line-through;">${{ product.productPrice }}</span>
																<span>${{ (product.dynamicPrice * (1 - product.discount / 100))|number_format(2) }}</span>
															</p>
														{% else %}
															<p class="item-price">
																<b>${{ product.dynamicPrice|number_format(2) }}</b>
															</p>
														{% endif %}
														<div class="button-group">
															<a href="{{ path('product_edit', {id: product.id}) }}" class="btn btn-edit">
																<i class="fas fa-edit"></i>
															</a>
															<form action="{{ path('product_delete', {id: product.id}) }}" method="post" style="display:inline-block;" onsubmit="return confirm('Are you sure you want to delete this product?');">
																<input type="hidden" name="_token" value="{{ csrf_token('delete' ~ product.id) }}">
																<button class="btn btn-delete">
																	<i class="fas fa-trash"></i>
																</button>
															</form>
															<form action="{{ path('product_vote', {id: product.id, type: 'up'}) }}" method="post" style="display:inline-block;">
																<button type="submit" class="btn btn-vote-up">
																	<i class="fas fa-thumbs-up"></i>
																</button>
															</form>
															<form action="{{ path('product_vote', {id: product.id, type: 'down'}) }}" method="post" style="display:inline-block;">
																<button type="submit" class="btn btn-vote-down">
																	<i class="fas fa-thumbs-down"></i>
																</button>
															</form>
														</div>
													</div>
												</div>
											</div>
										{% endfor %}
									</div>
								</div>
							{% endfor %}
						</div>
						<!-- Carousel controls -->
						<a class="carousel-control-prev" href="#myCarousel" data-slide="prev">
							<i class="fa fa-angle-left"></i>
						</a>
						<a class="carousel-control-next" href="#myCarousel" data-slide="next">
							<i class="fa fa-angle-right"></i>
						</a>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- Include jQuery and Bootstrap JS (for Bootstrap 4) -->
	<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
	<script src="{{ asset('js/bootstrap.min.js') }}"></script>

	<!-- JavaScript for Filter Toggle and Ajax Submission -->
	<script>
		document.addEventListener("DOMContentLoaded", function () {
			const filterToggle = document.getElementById('filterToggle');
			const filterPanel = document.getElementById('filterPanel');
			const filterForm = filterPanel;
			const productListContainer = document.getElementById('product-list-container');

			filterToggle.addEventListener('click', function () {
				filterPanel.classList.toggle('active');
			});

			filterForm.addEventListener('submit', function (e) {
				e.preventDefault();
				const formData = new FormData(filterForm);
				const queryString = new URLSearchParams(formData).toString();
				fetch(filterForm.action + '?' + queryString, {
					headers: {
						'X-Requested-With': 'XMLHttpRequest'
					}
				}).then(response => response.text()).then(html => {
					const parser = new DOMParser();
					const doc = parser.parseFromString(html, 'text/html');
					const newContent = doc.getElementById('product-list-container');
					if (newContent) {
						productListContainer.innerHTML = newContent.innerHTML;
						// Reinitialize carousel
						if ($('#myCarousel').data('bs.carousel')) {
							$('#myCarousel').carousel('dispose');
						}
						$('#myCarousel').carousel({interval: 0});
						// Reinitialize WOW.js animations
						new WOW().init();
					}
				}).catch(error => console.error('Error fetching filtered products:', error));
			});

			// Initial WOW.js initialization
			new WOW().init();
		});
	</script>
{% endblock %}

{% include 'frontend/footer/footer.html.twig' %}
</body>
</html>